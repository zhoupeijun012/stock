const dayjs = require("dayjs");
const { col, Op, cast } = require("sequelize");

const template = [
  { prop: "f2", label: "最新价" },
  { prop: "f3", label: "涨跌幅" },
  { prop: "f4", label: "涨跌额" },
  { prop: "f5", label: "总手" },
  { prop: "f6", label: "成交额" },
  { prop: "f7", label: "振幅" },
  { prop: "f8", label: "换手率" },
  { prop: "f9", label: "市盈率" },
  { prop: "f10", label: "量比" },
  { prop: "f11", label: "5分钟涨跌幅" },
  { prop: "f12", label: "股票代码" },
  { prop: "f13", label: "市场" },
  { prop: "f14", label: "股票名称" },
  { prop: "f15", label: "最高价" },
  { prop: "f16", label: "最低价" },
  { prop: "f17", label: "开盘价" },
  { prop: "f18", label: "昨收" },
  { prop: "f20", label: "总市值" },
  { prop: "f21", label: "流通市值" },
  { prop: "f22", label: "涨速" },
  { prop: "f23", label: "市净率" },
  { prop: "f24", label: "60日涨跌幅" },
  { prop: "f25", label: "年初至今涨跌幅" },
  { prop: "c1", label: "交易类型",filter: 'eq' },
];
const T_CODE = [
  "518860",
  "159937",
  "518660",
  "518880",
  "159934",
  "518850",
  "518800",
  "159812",
  "518680",
  "159834",
  "518600",
  "159831",
  "159830",
  "518890",
  "159980",
  "159981",
  "159985",
  "159636",
  "159750",
  "513020",
  "513560",
  "513860",
  "159751",
  "513150",
  "513980",
  "513160",
  "159747",
  "513180",
  "159740",
  "513260",
  "513130",
  "513890",
  "513010",
  "513580",
  "159742",
  "513380",
  "159741",
  "513120",
  "159718",
  "513700",
  "159506",
  "159776",
  "159892",
  "513200",
  "513060",
  "513280",
  "159615",
  "513320",
  "159822",
  "513960",
  "159735",
  "513230",
  "513590",
  "513070",
  "159699",
  "513970",
  "513360",
  "159850",
  "159960",
  "159954",
  "159823",
  "510900",
  "513660",
  "159920",
  "513600",
  "513550",
  "513900",
  "159788",
  "159712",
  "159711",
  "513990",
  "513530",
  "513690",
  "513950",
  "159691",
  "159726",
  "513140",
  "513090",
  "513330",
  "159688",
  "159792",
  "511670",
  "511810",
  "511800",
  "511950",
  "511860",
  "159003",
  "511850",
  "159005",
  "511830",
  "159001",
  "511820",
  "511880",
  "511960",
  "511980",
  "511910",
  "511930",
  "511900",
  "511920",
  "511970",
  "511650",
  "511600",
  "511700",
  "511660",
  "511620",
  "511990",
  "511690",
  "511770",
  "511010",
  "511260",
  "511020",
  "511360",
  "511090",
  "511520",
  "511220",
  "511580",
  "511030",
  "511060",
  "159816",
  "511270",
  "159972",
  "511380",
  "511180",
  "513770",
  "159605",
  "513040",
  "513050",
  "159607",
  "159941",
  "159509",
  "513100",
  "513300",
  "159660",
  "159501",
  "159513",
  "159659",
  "513390",
  "159632",
  "513290",
  "513110",
  "513650",
  "159612",
  "159655",
  "513500",
  "159687",
  "513310",
  "513880",
  "159866",
  "513000",
  "513520",
  "513800",
  "513030",
  "513220",
  "513080",
  "159529",
  "159329",
  "159561",
  "520830",
  "513400",
  "159518",
  "513850",
  "159577",
  "159696",
  "513870",
  "513350",
  "161130",
  "161128",
  "501307",
  "161125",
  "159502",
  "520990",
  "513630",
  "520900",
  "520660",
  "513820",
  "513910",
  "513810",
  "513190",
  "513920",
  "159545",
  "513170",
  "513210",
  "501312",
  "513730",
  "159312",
  "162415",
  "159569",
  "159333",
  "159557",
  "513780",
  "164824",
  "501300",
  "159331",
  "513750",
  "159302",
  "520520",
  "159568",
  "520890",
  "159570",
  "159567",
  "161127",
  "159303",
  "159519",
  "520700",
  "501301",
  "160140",
  "159318",
  "501025",
  "164705",
  "160924",
  "501302",
  "501305",
  "160717",
  "161126",
  "501306",
  "501225",
  "160644",
  "161831",
  "501021",
  "160322",
  "161124",
  "501303",
  "164906",
  "501310",
];

class Etf extends require("./base-query") {
  constructor(params) {
    super(params);
  }
  async getPage(params) {
    const queryParams = {
      np: 1,
      fltt: 1,
      invt: 2,
      cb: "cb",
      fs: "b:MK0021,b:MK0022,b:MK0023,b:MK0024,b:MK0827",
      fields: this.modelKeys.join(","),
      fid: "f3",
      pn: params.pageNum,
      pz: params.pageSize,
      po: 1,
      dect: 1,
      ut: "fa5fd1943c7b386f172d6893dbfba10b",
      wbp2u: "|0|0|0|web",
      _: Date.now(),
    };
    const res = await HTTP.get(`https://push2.eastmoney.com/api/qt/clist/get`, {
      params: queryParams,
    });
    let data = res.data;
    data = data.slice(3, -2);
    data = JSON.parse(data).data || {};
    const { total, diff = [] } = data;

    diff.forEach((item) => {
      if (T_CODE.includes(item["f12"])) {
        item["c1"] = "0";
      } else {
        item["c1"] = "1";
      }
    });

    const pages = Math.ceil(total / diff.length);
    return {
      total,
      list: diff,
      pageSize: diff.length,
      pageNum: params.pageNum,
      pages,
    };
  }
  queryPage(params) {
    const { pageNum, pageSize, matchKey = [], order = [], where = {} } = params;
    const tableOrders = this.orderArray(order);

    let whereArr = [];
    const { andArr, orArr } = this.whereArray(where);
    whereArr = whereArr.concat(andArr);
    whereArr = whereArr.concat(orArr);
    const whereMap = {
      [Op.and]: whereArr,
    };
    return super.queryPage({
      pageNum,
      pageSize,
      matchKey,
      order: tableOrders,
      where: whereMap,
    });
  }
}

module.exports = new Etf({
  name: "etf",
  template,
  chineseName: "ETF",
  updateKey: "f12",
  extend: [
    ...require(RESOLVE_PATH("spider/model/kline")).extend,
    ...require(RESOLVE_PATH("spider/model/fund")).extend
  ]
});
